---

- name: Add Dockerâ€™s official GPG key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add Docker Repository
  apt_repository:
    repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable
    state: present
    filename: docker
    mode: 0600

- name: create /etc/docker directory
  ansible.builtin.file:
    path: /etc/docker
    state: directory

- name: Make docker use systemd to manage cgroups
  ansible.builtin.copy:
    src: files/etc/docker/daemon.json
    dest: /etc/docker/daemon.json
  notify: restart docker


- name: Create containerd config file
  file:
    path: "/etc/modules-load.d/containerd.conf"
    state: "touch"

- name: Add conf for containerd
  blockinfile:
    path: "/etc/modules-load.d/containerd.conf"
    block: |
          overlay
          br_netfilter

- name: modprobe
  shell: |
          sudo modprobe overlay
          sudo modprobe br_netfilter

- name: Set system configurations for Kubernetes networking
  file:
    path: "/etc/sysctl.d/99-kubernetes-cri.conf"
    state: "touch"

- name: Add conf for containerd
  blockinfile:
    path: "/etc/sysctl.d/99-kubernetes-cri.conf"
    block: |
          net.ipv4.ip_forward = 1
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
    
- name: Apply new settings
  command: sudo sysctl --system

- name: Installing required packages
  apt:
    name: firewalld
    state: present

- name: Starting and Enabling the required services
  service:
    name: firewalld
    state: started
    enabled: yes

- name: Allow Network Ports in Firewalld
  ansible.posix.firewalld:
    port: "{{ item }}"
    state: enabled
    permanent: yes
    immediate: yes
  with_items: "{{ master_ports if ('k8sControlPlanes' in group_names) else worker_ports }}"

- name: install docker community edition
  ansible.builtin.apt:
    name: "{{ packages }}"
    state: present
    update_cache: yes
    cache_valid_time: 3600
  vars:
    packages:
    - docker-ce
    - docker-ce-cli
    - containerd.io

- name: Remove config.toml
  become: true
  shell: |
          rm /etc/containerd/config.toml
          systemctl restart containerd
